### 事件

1. redis服务器是一个事件驱动程序。需要处理文件事件和时间事件。

   - 文件事件是redis服务器对套接字的操作的一种抽象。服务器和客户端通信会产生相应的文件事件，服务器通过监听并处理这些事件完成一系列操作。
   - 时间事件是服务器对一些定时操作（如serverCron函数）的抽象。

2. 文件事件和文件事件处理器

   - redis的文件事件处理器基于reactor模式，采用IO多路复用同时监听多个套接字，根据套接字不同任务关联不同的事件处理器（一个个函数，定义了某个事件发生时服务器应该执行的操作）。当被监听的套接字准备执行accept、read、write、close等操作时，会产生相应的文件事件（对套接字操作的抽象），从而会触发与套接字关联的事件处理器来处理这些事件。

   - 文件事件处理器以单线程方式运行，通过IO多路复用技术实现高性能网络通信。redis的多路复用程序是通过select、epoll、evport、kqueue实现的。redis为每一个IO多路复用函数库实现相同的api，程序在编译时会自动选择系统中性能最高的IO多路复用函数库作为底层实现。

   - 文件事件处理器由套接字、IO多路复用程序、文件事件分派器、事件处理器组成。

   - 一个服务器可能会同时监听多个套接字，并向文件事件分派器传送。尽管多个文件事件会并发出现，但是IO多路复用程序会将所有产生事件的套接字放进一个队列中，通过这个队列有序、同步、每次一个套接字的方式传送给文件事件分派器。

   - redis中不同的事件处理器用于实现不同的网络通信需求。

     （1）连接应答处理器

     ​	当客户端连接监听套接字时，产生AE_READABLE事件，触发连接应答处理器对连接服务器的各个客户端进行应答。

     （2）命令请求处理器

     ​	当客户端向服务器发送命令请求时，产生AE_READABLE事件，触发连接命令请求处理器执行套接字读入操作。在客户端连接服务器整个过程，服务器会一直为客户端的AE_READABLE时间关联命令请求处理器。

     （3）命令回复处理器

     ​	当服务器有命令回复返回给客户端时，服务器会将客户端套接字的AE_WRITABLE事件和命令回复处理器关联，当客户端准备接收服务器的命令回复时产生AE_WRITABLE事件，触发命令回复处理器执行相应的套接字写入操作。

     （4）复制处理器

     ​	用于主服务器和从服务器进行赋值操作时。

3. 时间事件

   - 一个时间事件由三个属性组成：全局唯一id、when、timeProc。新事件的id大于旧事件的id。when记录事件到达时间，timeProc时间事件处理器会在时间事件到达后被调用处理事件。

   - redis服务器采用周期性事件。服务器将所有的时间事件放在一个无序链表中。在redis服务器中只使用了serverCron一个时间事件，无序链表退化成一个指针，所以使用无序链表并不影响事件执行效率。

   - serverCron

     （1）用来定期对redis服务器自身的资源和状态进行检查和调整。比如更新服务器各类统计信息，如时间、内存占用、数据库占用情况等，清理过期键值对，关闭清理失效客户端，aof和rdb持久化，主从同步等。

     （2）可以通过修改hz选项调整serverCron每秒执行次数。

4. 对文件事件和时间事件的处理都是同步、有序、原子的，不会中途中断事件处理，也不会进行抢占。时间事件在文件事件之后执行。时间事件实际处理时间会比hz设定的时间稍晚一些。