### 客户端

1. redisClient结构保存了客户端当前的状态信息以及执行相关功能时需要用到的数据结构。在redisServer中的clients是一个链表，保存所有与服务器连接的客户端状态结构。

2. redisClient通用属性

   - fd

     客户端正在使用的套接字描述符。伪客户端fd值是-1。redis中，伪客户端主要用于lua脚本执行和载入执行aof文件。普通客户端fd是大于-1的整数。使用client list可以查看目前连接的所有的客户端。

   - name

     默认情况下连接到服务器的客户端name为NULL，可以通过client setname设置客户端的名字。

   - flags

     客户端的状态和角色。

   - querybuf

     输入缓冲区用于保存客户端发送的命令请求。缓冲区大小会根据输入内容动态缩小扩大，最大不超过1G。

   - argv和argc

     argv是一个数组。argv[0]是执行的命令名字。后面的是传给命令的参数。

     argc是argv数组的长度。

   - cmd

     命令实现函数。服务器会根据argv[0]命令名字在命令表字典中查找对应的redisCommad结构，并将cmd指向这个结构。查找过程不区分命令名称大小写。

   - 输出缓冲区

     用来保存执行命令返回的命令回复。分为固定缓冲区和可变缓冲区。固定缓冲区用于保存长度较小的回复，默认最大长度16K。当固定缓冲区空间使用完毕后，采用可变缓冲区，可变缓冲区是一个链表结构。

   - authenticated

     用于记录客户端是否通过身份验证。在启用身份验证的情况下（requirepass选项），authenticated为0表示未通过验证，除了auth其他所有命令都会被拒绝执行。authenticated为1表示通过验证。

   - ctime

     客户端创建的时间。

   - lastinteraction

     客户端和服务器最后一次交互时间。可用来计算客户端空闲时间。

   - obuf_soft_limit_reached_time

     输出缓冲区第一次到达软性限制的时间。

3. 关闭客户端的情况

   - 客户端进程退出或者被杀死。
   - 客户端向服务器发送不符合协议格式的命令请求。
   - 客户端成为CLient kill的目标。
   - 服务器设置了timeout选项并且当客户端空转时间超过timeout。除了客户端是主、从服务器，正在被blpop等命令阻塞，或者正在执行subscribe、psubscribe等订阅命令，即使空转时间超过timeout也不会被关闭。
   - 客户端发送命令请求大小超过输入缓冲区大小（默认1G）。
   - 发送回客户端的命令回复大小超过输出缓冲区大小。输出缓冲区限制分为硬性限制和软性限制。超过硬性限制，服务器将立刻关闭该客户端。如果超过软性限制，但是不超过硬性限制，服务器将使用客户端状态结构中的obuf_soft_limit_reached_time属性记录输出缓冲区第一次到达软性限制的时间，并继续监视客户端。如果输出缓冲区大小一直超过软性限制并持续时间超过服务器设置时长，服务器将会关闭客户端。可以使用client-out-buffer-limit为普通客户端、从服务端执行发布订阅客户端设置不同的硬性限制和软性限制。