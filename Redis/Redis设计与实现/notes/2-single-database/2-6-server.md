### 服务器

1. 服务器执行命令流程

   - 在redis客户端键入一个命令请求，客户端会将其转换成协议格式，然后通过连接服务器的套接字将协议格式发送给服务器。

   - 服务器读取套接字中协议格式的命令，将其保存在客户端状态结构中的输入缓冲区中。并对输入缓冲区中的命令请求分析，提取命令参数以及参数个数，保存在客户端状态的argv和argc中。

   - 调用命令执行器执行命令。

     （1）根据argv[0]在命令表字典中查找到命令所对应的的redisCommand结构（记录了redis命令的实现信息），并保存在客户端状态的cmd中。

     （2）正式执行命令前的预备操作，包括检查cmd是否是NULL，检查命令参数个数，是否通过身份验证等。

     （3）调用命令的实现函数，产生相应的命令回复，并将其保存在客户端状态的输出缓冲区中。另外，命令实现函数还会为客户端的套接字关联命令回复事件处理器，负责将命令回复返回客户端。

     （4）执行后续工作。如如果开启慢查询日志功能，会检查是否需要添加新的慢查询日志。开启aof持久化等等。

   - 将命令回复发送给客户端，并清空输出缓冲区。

   - 客户端接收并打印命令回复。

2. severCron函数

   - redisServer中的unixtime和mstime分别缓存了秒级和毫秒级的系统当前时间戳。severCron默认会以100ms一次的频率更新这两个时间。一般用做日志打印、更新LRU时钟等对时间精确度不高的功能。如果是要用于设置键的过期时间，添加慢查询日志等高精度时间要求功能，服务器会再次执行系统调用，获得最精确的时间。
   - redisServer中lruclock属性保存服务器的LRU时钟。severCron默认每10秒更新一次时钟缓存。可以通过info server查看lru_clock。
   - 更新服务器每秒执行命令次数。可以使用info status查看。
   - 更新服务器内存峰值记录。可以使用info memory查看。
   - 检查服务器状态中的shutdown_asap决定是否关闭服务器。
   - 管理客户端资源和数据库资源。
   - 执行延迟的bgrewriteaof。
   - 检查持久化操作的运行状态。
   - 将aof缓冲区中的数据写入到aof文件中。
   - 关闭输出缓冲区超过限制大小的客户端。
   - 记录serverCron函数执行次数。

3. 初始化服务器

   - 初始化redisServer结构，调用initServerConfig函数完成对redisServer属性默认值的设置。
   - 载入用户自定义配置选项，并对redisServer属性进行修改。
   - 初始化服务器数据结构。在之前调用initServerConfig函数，程序只会创建命令表一个数据结构。而redisServer.clients、redisServer.db、redisServer.pubsub_channels等一系列数据结构会在这个阶段调用initServer函数创建。之所以在这个阶段初始化数据结构是因为初始化数据结构需要根据载入的用户自定义配置。initServer除了主要负责初始化数据结构，还负责创建共享对象（如OK回复字符串对象、ERR字符串对象、1-10000的字符串对象等，避免服务器反复创建这些对象）、打开服务器监听端口、为serverCron函数创建时间事件等一系列操作。
   - 通过载入RDB文件或者AOF文件还原数据库状态。如果开启AOF功能，优先使用AOF文件还原。
   - 执行事件循环。   