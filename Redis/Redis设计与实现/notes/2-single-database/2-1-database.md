### 数据库

1. redis服务器状态都是由redisServer结构表示的。redisServer的属性db是一个redisDb数组。每一个redisDb代表一个redis数据库。redisServer的属性dbnum记录服务器初始化的数据库个数。默认16个。

2. redis客户端状态由redisClient结构表示。redisClient的db属性记录客户端当前的目标数据库，会指向redisServer.db数组中的一个元素。select命令原理就是通过修改redisClient.db指针，让其指向redisServer.db中不同的redisDb达到切换数据库的功能。

3. redisDb当中有一个属性dict字典，真正保存了redis数据库中所有键值对。这个字典称为键空间。

   - 所有对数据库的操作，包括对键的增删改查操作、flushall、dbsize、randomKey等，实际上都是通过对键空间字典操作实现的。
   - 另外，还会对键空间执行一些额外的维护操作。比如读取一个键后根据键是否存在更新键空间命中和不命中次数，可以通过info stats的keyspace_hits属性和keyspace_misses属性查看。在读取一个键后服务器会更新lru时间，可用于计算键的闲置时间，可以通过object idletime查看。当键已经过期后会先删除过期键再执行余下操作。服务器每次修改一个键，会对dirty计数器增一。这个计数器会触发服务器的持久化和赋值操作。如果服务器开启了数据库通知功能，在对键修改后，服务器会发起相应的数据库通知。

4. 键的生存时间和过期时间

   - 可以使用expire或者pexpire命令以秒或者毫秒精度设置键的生存时间（TTL），用expireat或者pexpireat设置键的过期时间，用ttl或者pttl返回指定键的剩余生存时间。expire、pexpire、expireat都是用pexpireat命令经过转换后实现的。
   - redisDb当中有一个属性expires字典保存了数据库中所有键的过期时间，这个字典称为过期字典。字典的键指向键空间中的某个键对象，值是一个long long类型整数，保存字典键所指向的数据库键的过期时间。
   - 可以使用persist移除一个键的过期时间。通过在过期字典中查找给定的键，解除该键与其对应的过期时间在字典中的关联实现。

5. 过期键删除策略

   redis采用的过期键删除策略是惰性删除和定期删除。通过配合这两种策略可以很好地在合理使用CPU时间和避免内存浪费取得平衡。

   - 惰性删除是指程序只会在取出键的时候才会对键过期检查。通过expireIfNeeded函数实现。所有读写操作执行前都会先调用expireIfNeeded函数过滤检查，如果该键过期则删除。否则正常执行。
   - 定期删除是指每隔一段时间执行一次删除过期键操作。通过activeExpireCycle函数实现。activeExpireCycle会被serverCron定时周期调用，在规定时间内，分多次遍历所有数据库，从每个数据库的expires字典中随机检查一部分键的过期时间，并删除其中的过期键。

6. AOF、RDB、复制操作对过期键的处理

   - 使用save或者bgsave保存RDB时，会先检查键是否过期，已过期的键不会被保存到新的RDB文件中。载入RDB的时候，如果是主服务器模式运行，则会进行过期键检查，未过期的键会被载入，过期键会被忽略。如果是以从服务器运行，不管是否过期都会被载入。不过主从同步时，会先将从服务器的数据库清空，所以一般不会有影响。

   - 当服务器以AOF模式运行，未被删除的过期键不会对AOF文件有任何影响。当过期键被惰性删除或者定期删除后，AOF文件中会被追加一条DEL命令，显示记录该键被删除。在AOF重写过程中，会对键进行过期检查，已过期的键不会被保存到崇重写的AOF文件当中。

   - 当服务器运行在复制模式下，从服务器的过期键删除动作统一由主服务器控制：

     （1）主服务器删除一个过期键后会显式的向所有从服务器发送DEL命令，告知从服务器删除该过期键。

     （2）从服务器执行客户端发送的读命令时，即使遇到过期键也不会删除。从服务器只有在接到主服务器发送的DEL命令才会删除过期键。

7. 数据库通知