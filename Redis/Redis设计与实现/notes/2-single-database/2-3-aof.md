### AOF持久化

1. RDB持久化是通过保存数据库中所有键值对来记录数据库状态的，而AOF持久化是通过保存redis服务器所执行的写命令来记录数据库状态的。

2. AOF持久化分为追加、文件写入、文件同步三个步骤。

   - 追加

     AOF功能打开状态下，服务器执行完一个写命令后，会以协议格式将被执行的命令追加到服务器redisServer中的aof_buf缓冲区末尾。

   - 写入与同步

     redis服务器每次结束一个事件循环之前，会根据配置的appendfsync选项决定是否将aof_buf中的内容写入保存到AOF文件中。

     appendfsync选项：

     1. always：将aof_buf缓冲区的所有内容写入并同步到AOF文件。效率最低，安全性最高。
     2. everysec：将aof_buf缓冲区的所有内容写入AOF文件。如果上次同步AOF文件时间距离现在超过1秒钟，则同步。
     3. no：将aof_buf缓冲区的所有内容写入到AOF文件，但不同步AOF。何时同步由操作系统决定。效率最高，安全性最低。

3. AOF重写rewriteaof

   - AOF重写是为了解决AOF文件体积膨胀问题。
   - aof重写不需要对旧的AOF文件做任何读取、分析、写入操作，aof文件重写功能是通过服务器端当前数据库状态实现的。
   - aof重写函数是阻塞的，如果直接在服务器进程操作会阻塞服务器处理其他请求。redis服务器是将AOF重写程序放在子进程里执行。不过在AOF重写过程中，父进程会继续处理命令请求，新的命令有可能修改现有的数据库状态，导致当前的数据库状态和AOF重写后所保存的数据库状态不一致。为了解决这种不一致的问题，redis服务器设置了AOF重写缓冲区。当redis服务器执行一个写命令时，同时将这个写命令发送给AOF缓冲区和AOF重写缓冲区。AOF缓冲区的数据会被定期写入到AOF文件，当子进程完成AOF重写后，会向父进程发送一个信号，父进程接收信号后会将AOF重写缓冲区中的数据写入到新的AOF文件，保证新的AOF文件保存的数据库状态和当前的状态一致。