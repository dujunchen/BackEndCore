### 集群

1. 节点
   
   - 使用clusterNode表示一个节点当前状态，包含创建节点的时间，节点名称，节点标识，配置纪元和clusterLink等。clusterLink保存连接节点所需要的信息。另外，每个节点保存着一个clusterState结构，有myself（指向当前节点）、currentEpoch（当前纪元）、State（集群状态）、size（正在处理slot集群节点数量）、nodes字典（集群中所有的节点）属性。
   
   - （A）节点可以使用cluster meet <ip> <port>将指定的节点加入到当前节点所在的集群中。
     
     A节点会为B创建clusterNode结构并保存在自己的clusterState.nodes字典中，然后发送MEET消息给B。收到命令的节点（B）也会为A创建clusterNode结构并保存在自己的clusterState.nodes字典中，然后返回A一个PONG消息。A收到PONG后会再给B发送PING消息，握手完成。之后A会将B的信息通过Gossip协议传播给集群中其他节点，其他节点与B 一一握手后，B节点会被所有节点认识。
   
   - 集群模式下各节点只能使用0号数据库。

2. slot分派
   
   - redis集群采用分片的方式将数据库的键值对按照键分派给16384个slot保存（可以使用cluster keyslot <key>查看某个key所在的slot），redis集群中的每个节点可以处理0到16384个slot。当16384个slot都有节点在处理，集群处于上线状态（ok）。任何一个slot没有被处理，集群就处于下线状态（fail）。
   
   - 可以使用cluster addslots <slot1> <slot2> ...给当前节点指派指定的slot。
   
   - 每一个clusterNode结构中slots和numslot属性用来记录这个节点所负责的slot。slots是一个长度为16384的位数组，每一个索引上0或者1，1表示负责该slot，0表示不负责。numslots记录节点负责的slot数量，即slots数组中1的个数。程序检查某个节点是否负责某个slot，或者将某个slot分派给节点负责的复杂度都是O(1)。每个节点都会将自己的slots通过消息发送给集群中其他节点，其他接收到slots的节点都会将自己的clusterState.nodes字典中该节点对应的clusterNode.slots相应更新，因此集群中每一个节点都知道16384个slot的指派情况。
   
   - 每一个clusterState结构中会维护一个slots数组，表示集群中每个slot的指派情况。如果索引i位置指向NULL，表示该slot没有被指派给任何节点，如果索引i位置指向一个clusterNode，表示该slot被指派给该节点。
   
   - 同时维护clusterNode.slots和clusterState.slots数组的原因
     
     clusterNode.slots可以使得获取某个节点的slot分派情况复杂度O(1)。
     
     clusterState.slots可以使得获取某个slot是否被分派或者分派给哪个节点复杂度O(1)。
   
   - 集群模式下，客户端向某个节点发送某个键命令，通过CRC16(key) & 16383 计算所得的slot如果刚好是本节点（通过对比clusterState.slots[i]==clusterState.myself），则直接执行命令并返回。如果不是本节点，节点会返回MOVED错误，指引客户端转向正确的节点执行。
   
   - slot重新指派
     
     - redis集群的slot重新分派操作可以将任意数量已经指派给某一个节点的slot改为指派给另一个节点，并且相关slot的键值对也会从源节点移动到目标节点。
     - redis重新指派slot操作可以在线操作，并且源节点和目标节点都可以继续处理命令请求。
   
   - ASK错误
     
     在重新分派slot期间，某一个slot的键值对数据可能一部分存在源节点，一部分已经被迁移到目标节点了。当客户端刚好发送的键命令的键位于正在迁移中的slot时，源节点会先在自己的数据库中查找该键，如果找到则直接执行命令返回。如果找不到，则该键可能已经被迁移到目标节点，这时会向客户端返回ASK错误，指引客户端转向正在导入的目标节点。
   
   - ASK错误和MOVED错误
     
     这两个错误都会导致客户端转向，区别在于，MOVED错误是客户端访问的键值对的slot在另一个节点上。ASK错误是两个节点在迁移slot时一种临时的措施，不会对客户端发送关于该slot的命令产生影响。

3. 故障转移
   
   - Redis集群中主节点负责处理slot，从节点用于复制主节点，并在主节点下线时替代处理下线主节点负责的slot。可以使用cluster replicate <node_id>可以成为指定的主节点的从节点并对其复制，并且这一信息会通过消息发送给集群中其他节点，最终每个节点都会知道某个从节点正在复制某个主节点。
   
   - 集群中每个节点都会定期向其他节点发送PING消息，如果接收的节点没有在规定时间返回PONG，那么该节点会将其标记为疑似下线（PFAIL）。集群中各节点会通过消息交换各节点的状态信息，如在线、PFAIL、或者下线。如果一个集群中，半数以上节点将某一个节点标记为PFAIL，集群中所有的其他节点都会通过消息得知该消息并将该节点标记为下线（FAIL）。
   
   - 当一个从节点发现自己正在复制的主节点已下线，从节点会开始对主节点进行故障转移。
     
     （1）从已下线主节点所有从节点中选举一个新的主节点。
     
     ​        选举机制和sentinel选举leader相似。每个从节点会向集群广播消息要求有投票权的主节点给自己投票，如果一个主节点有投票权并尚未投票给其他从节点，会向该从节点回复ACK消息，表示支持每个节点可以统计自己取得的支持票数。如果一个从节点获得了集群中半数以上具有投票权主节点的支持，就成为新的主节点，如果一个配置纪元里面没有选举成功，会进入一个新的纪元并再次选举，直至选出新的主节点为止。
     
     （2）被选中的从节点执行slave no one称为新主节点。
     
     （3）新主节点撤销所有对已下线主节点的slot分派，并将其指派给自己。
     
     （4）新主节点向集群广播PONG消息，告知其余节点立刻知道自己已经成为新的主节点。