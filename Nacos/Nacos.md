# Nacos

## 核心功能

### 服务注册

- Nacos Client服务启动初始化Spring时，会自动触发注册逻辑。通过REST请求方式向Nacos Server注册自己的服务，上报自己的元数据（IP和端口等）。Nacos Server收到注册信息后，会将其保存在内存的双层Hashmap中

### 服务发现

- 当Nacos Client需要调用其它的Nacos Client的接口时，会先从Nacos Server拉取最新的注册服务列表，并且缓存在本地，并且会同时开启一个定时任务，定时刷新注册服务列表到缓存

### 服务心跳

- 服务注册完成后，Nacos Client默认5s会定时向Nacos Server发送心跳保活

### 服务同步

- Nacos Server集群各节点之间相互同步注册的服务实例，保证数据的一致性

### 健康检查

- Nacos Server也会定时检查注册服务实例的健康情况，对于超过15s未收到心跳的服务，会标记healthy为false，不会被发现，超过30s会直接剔除该服务

## Nacos设计精髓

- 为了解决并发读写注册表冲突以及加锁性能问题，Nacos运用了copy on write的思想来实现读写分离，而Eureka是使用多级缓存之间定时同步的方式来实现读写分离，nacos client服务发现的及时性会比Eureka高很多

- 大量使用了内存队列来异步处理写操作，提升写操作的性能，对于写操作，一般会将其放入一个内存队列就算结束了，然后会开启另一个线程不断从队列中拉取任务继续处理。这样处理，可以使得客户端服务注册逻辑不会阻塞客户端应用启动

- 集群节点之间数据同步采用异步批量同步

- Nacos同时支持AP和CP模型，默认创建的是临时节点，是AP模型，维护的注册服务列表是维护在内存中的，所有的节点是对等架构。如果设置为持久化节点，则是CP模型，底层实现了Raft协议，通过选举Leader节点，以及事务二阶段提交来保证节点间数据的强一致性

- Nacos在实现简化版的Raft协议时，使用CountDownLatch实现了一个半数以上同步成功的效果，提高达成分布式一致的效率
